<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
  <head>
    <title>Secret Exchange</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">

    <style type="text/css">
      html, input { font-family: "DejaVu Sans Serif", "Trebuchet MS", Helvetica, sans-serif; }
      html { background-color: #F5F5F5; margin: 0; padding: 0; font-size: medium; }
      body { margin: 0; padding: 1em 2em; }
      input[type=text] { padding: .5ex; font-size: medium; }
      input[type=button] { padding: .5ex 1ex; font-size: small; font-weight: bold; }
      th, td { text-align: left; vertical-align: middle; padding: 1ex 0;}
      fieldset { margin: 0 0 1em 0; }
      sup, sub { line-height: 100%; }
    </style>

    <script type="text/javascript" src="bignumber.js"></script>

    <script type="text/javascript">

      var in_a, in_b, in_ga, in_gb, in_p, in_g;
      var in_put, out_put, out_gab;
      var but_a, but_b, but_ra, but_rb, but_enc, but_dec;

      var TheP = new BigNumber("124325339146889384540494091085456630009856882741872806181731279018491820800119460022367403769795008250021191767583423221479185609066059226301250167164084041279837566626881119772675984258163062926954046545485368458404445166682380071370274810671501916789361956272226105723317679562001235501455748016154805420913");
      var TheG = new BigNumber("115740200527109164239523414760926155534485715860090261532154107313946218459149402375178179458041461723723231563839316251515439564315555249353831328479173170684416728715378198172203100328308536292821245983596065287318698169565702979765910089654821728828592422299160041156491980943427556153020487552135890973413");

      var limit = new BigNumber(2).pow(100);

      function Init() {
          if (document.getElementById) {
              in_a    = document.getElementById("in_a");
              in_b    = document.getElementById("in_b");
              in_ga   = document.getElementById("in_ga");
              in_gb   = document.getElementById("in_gb");
              in_g    = document.getElementById("in_g");
              in_p    = document.getElementById("in_p");

              in_put  = document.getElementById("in_put");
              out_put = document.getElementById("out_put");
              out_gab = document.getElementById("out_gab");

              but_a   = document.getElementById("go_a");
              but_b   = document.getElementById("go_b");
              but_ra  = document.getElementById("but_ra");
              but_rb  = document.getElementById("but_rb");
              but_enc = document.getElementById("go_enc");
              but_dec = document.getElementById("go_dec");
          }

          if (but_a) {
              but_a.addEventListener("click", runAlice, false);
          }
          if (but_b) {
              but_b.addEventListener("click", runBob, false);
          }
          if (but_ra) {
              but_ra.addEventListener("click", fillAliceInput, false);
          }
          if (but_rb) {
              but_rb.addEventListener("click", fillBobInput, false);
          }

          if (but_enc) {
              but_enc.addEventListener("click", Encrypt, false);
          }

          if (but_dec) {
              but_dec.addEventListener("click", Decrypt, false);
          }

          in_g.value = TheG;
          in_p.value = TheP;
      }

      window.addEventListener("load", Init, false);

      function Extract(input) {
          var pattern = /^\s*\[\s*(\d+),\s*(\d+);\s*(\d+)\s*\]\s*$/;
          var match = pattern.exec(input);
          return {
              'p' : match[1],
              'g' : match[2],
              'A' : match[3]
          };
      }

      function ExpMod(Base, Expo, Modu) {
          var result = new BigNumber(1);
          while (Expo != 0) {
              if (Expo.mod(2) != 0) {
                  result = result.multiply(Base);
                  result = result.mod(Modu);
              }
              Base = Base.multiply(Base);
              Base = Base.mod(Modu);
              Expo = Expo.divide(2).intPart();
          }
          return result;
      }

      function fillAliceInput(ev) {
          in_gb.value = in_put.value;
          out_gab.value = compute(in_gb.value, in_p.value, in_a.value);
      }

      function fillBobInput_OFF(ev) {
          var r = Extract(in_put.value);
          in_g.value  = r['g'];
          in_p.value  = r['p'];
          in_ga.value = r['A'];
      }

      function fillBobInput(ev) {
          in_ga.value = in_put.value;
      }

      function compute(gx, px, nx) {
          var g = new BigNumber(gx);
          var p = new BigNumber(px);
          var n = new BigNumber(nx);

          //return res = (g.pow(n)).mod(p);
          return ExpMod(g, n, p);
      }

      function runAlice(ev) {
          in_ga.value = compute(in_g.value, in_p.value, in_a.value);
          //out_put.value = "[" + in_p.value + ", " + in_g.value + "; " + in_ga.value + "]";
          out_put.value = in_ga.value;
      }

      function runBob(ev) {
          in_gb.value = compute(in_g.value, in_p.value, in_b.value);
          out_gab.value = compute(in_ga.value, in_p.value, in_b.value);
          out_put.value = in_gb.value;
      }

      function Encrypt(ev) {
          var msg = document.getElementById("in_pt").value;
          var secret = new BigNumber(out_gab.value);

          var r = new BigNumber(0);
          var pad = 100 - msg.length;

          for (var i = 0; i < msg.length; ++i) {
              r = r.multiply(256);
              var b = secret.mod(256);
              r = r.add(msg.charCodeAt(i) ^ b);
              secret = secret.divide(256);
          }

          for (var i = msg.length; i < 100; ++i) {
              r = r.multiply(256);
              var b = secret.mod(256);
              r = r.add(pad ^ b);
              secret = secret.divide(256);
          }

          document.getElementById("in_et").value = r;
      }

      function Decrypt(ev) {
          var msg = new BigNumber(document.getElementById("in_et").value);
          var secret = new BigNumber(out_gab.value);

          var raw = Object();
          for (var i = 0; i < 100; ++i) {
              raw[i] = msg.mod(256);
              msg = msg.divide(256);
          }

          var r = "";
          var pad;
          for (var i = 0; i < 100; ++i) {
              pad = raw[100 - i - 1] ^ secret.mod(256);
              r += String.fromCharCode(pad);
              secret = secret.divide(256);
          }

          document.getElementById("in_pt").value = r.substring(0, 100 - pad);
      }

    </script>

  </head>

  <body>

    <h1>Secret Exchange</h1>

    <h2>Handshake</h2>

    <form action="" style="float: left; margin: 0 2em 0 0">
      <fieldset>
      <legend>The public data</legend>
      <table>
        <tbody>
          <tr>
            <th style="width: 2em;"><var>g</var></th>
            <td><input type="text" name="in_g" id="in_g" readonly="readonly"></td>
          </tr>
          <tr>
            <th><var>p</var></th>
            <td><input type="text" name="in_p" id="in_p" readonly="readonly"></td>
          </tr>
          <tr>
            <th><var>g</var><sup><var>a</var></sup></th>
            <td><input type="text" name="in_ga" id="in_ga"></td>
          </tr>
          <tr>
            <th><var>g</var><sup><var>b</var></sup></th>
            <td><input type="text" name="in_gb" id="in_gb"></td>
          </tr>
        </tbody>
      </table>
      </fieldset>
    </form>

    <form action="">
      <fieldset>
      <legend>Alice's private data</legend>
      <table>
        <tbody>
          <tr>
            <th style="width: 8em;"><var>a</var> (secret)</th>
            <td><input type="text" name="in_a" id="in_a"></td>
          </tr>
        </tbody>
      </table>
      </fieldset>
    </form>

    <form action="">
      <fieldset>
      <legend>Bob's private data</legend>
      <table>
        <tbody>
          <tr>
            <th style="width: 8em;"><var>b</var> (secret)</th>
            <td><input type="text" name="in_b" id="in_b"></td>
          </tr>
        </tbody>
      </table>
      </fieldset>
    </form>

    <form action="">
      <fieldset>
      <legend>The shared secret</legend>
      <table>
        <tbody>
          <tr>
            <th style="width: 8em;"><var>g</var><sup><var>ab</var></sup> (secret)</th>
            <td><input type="text" name="out_gab" id="out_gab"></td>
          </tr>
        </tbody>
      </table>
      </fieldset>
    </form>

    <p><strong>If you are Alice:</strong> Enter a secret <label for="in_a"><var>a</var></label> and
    then transmit <var>g</var><sup><var>a</var></sup> to Bob.
    <input type="button" id="go_a" value="1. I am Alice; initiate."></p>

    <p><strong>If you are Bob:</strong> Wait for the data from Alice, read it, and enter
    a secret <label for="in_b"><var>b</var></label>. Then send
    <label for="in_gb"><var>g</var><sup><var>b</var></sup></label> to Bob and compute the shared secret.
    <input type="button" id="go_b" value="4. I am Bob; make shared secret."></p>

    <p><strong>Alice again:</strong> Read Bob's token
    <label for="in_gb"><var>g</var><sup><var>b</var></sup></label> below and compute the shared secret.</p>

    <form action="">
      <fieldset>
      <legend>Input/Output</legend>
      <table>
        <tbody>
          <tr>
            <th style="width: 5em;">Input</th>
            <td style="width: 15em;"><input name="in_put" id="in_put" type="text"></td>
            <td><input type="button" id="but_rb" value="3. Read as Bob">
                <input type="button" id="but_ra" value="6. Read as Alice and compute shared secret"></td>
          </tr>
          <tr>
            <th>Output</th>
            <td><input name="out_put" id="out_put" type="text"></td>
            <td>2. Send to Bob. 5. Send to Alice.</td>
          </tr>
        </tbody>
      </table>
      </fieldset>
    </form>

    <h2>Talk</h2>

    <form action="">
      <table>
        <tbody>
          <tr>
            <th>Plaintext (secret)</th>
            <td><input name="in_pt" id="in_pt" size="50" type="text"></td>
            <td><input type="button" id="go_enc" name="go_enc" value="Encrypt"></td>
          </tr>
          <tr>
            <th>Encrypted (public)</th>
            <td><input name="in_et" id="in_et" size="50" type="text"></td>
            <td><input type="button" id="go_dec" name="go_dec" value="Decrypt"></td>
          </tr>
        </tbody>
      </table>
    </form>

  </body>
</html>
