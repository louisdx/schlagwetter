<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
  <head>
    <title>Secret Exchange</title>

    <script type="text/javascript" src="bignumber.js"></script>

    <script type="text/javascript">

      var in_a, in_b, in_ga, in_gb, in_p, in_g;
      var in_put, out_put, out_gab;
      var but_a, but_b, but_ra, but_rb;

      var TheP = new BigNumber("0xB10B8F96A080E01DDE92DE5EAE5D54EC52C99FBCFB06A3C69A6A9DCA52D23B616073E28675A23D189838EF1E2EE652C013ECB4AEA906112324975C3CD49B83BFACCBDD7D90C4BD7098488E9C219A73724EFFD6FAE5644738FAA31A4FF55BCCC0A151AF5F0DC8B4BD45BF37DF365C1A65E68CFDA76D4DA708DF1FB2BC2E4A4371");
      var TheG = new BigNumber("0xA4D1CBD5C3FD34126765A442EFB99905F8104DD258AC507FD6406CFF14266D31266FEA1E5C41564B777E690F5504F213160217B4B01B886A5E91547F9E2749F4D7FBD7D3B9A92EE1909D0D2263F80A76A6A24C087A091F531DBF0A0169B6A28AD662A4D18E73AFA32D779D5918D08BC8858F4DCEF97C2A24855E6EEB22B3B2E5");

      function Init() {
          if (document.getElementById) {
              in_a  = document.getElementById("in_a");
              in_b  = document.getElementById("in_b");
              in_ga = document.getElementById("in_ga");
              in_gb = document.getElementById("in_gb");
              in_g  = document.getElementById("in_g");
              in_p  = document.getElementById("in_p");

              in_put  = document.getElementById("in_put");
              out_put = document.getElementById("out_put");
              out_gab = document.getElementById("out_gab");

              but_a  = document.getElementById("go_a");
              but_b  = document.getElementById("go_b");
              but_ra = document.getElementById("but_ra");
              but_rb = document.getElementById("but_rb");
          }

          if (but_a) {
              but_a.addEventListener("click", runAlice, false);
          }
          if (but_b) {
              but_b.addEventListener("click", runBob, false);
          }
          if (but_ra) {
              but_ra.addEventListener("click", fillAliceInput, false);
          }
          if (but_rb) {
              but_rb.addEventListener("click", fillBobInput, false);
          }

          in_g.value = TheG;
          in_p.value = TheP;
      }

      window.addEventListener("load", Init, false);

      function Extract(input) {
          var pattern = /^\s*\[\s*(\d+),\s*(\d+);\s*(\d+)\s*\]\s*$/;
          var match = pattern.exec(input);
          return {
              'p' : match[1],
              'g' : match[2],
              'A' : match[3]
          };
      }

      function ExpMod(Base, Expo, Modu) {
          var result = new BigNumber(1);
          while (Expo >= 1) {
              if (Expo.mod(2) != 0) {
                  result = result.multiply(Base);
                  result = result.mod(Modu);
              }
              Base = Base.multiply(Base);
              Base = Base.mod(Modu);
              Expo = Expo.divide(2);
          }
          return result;
      }

      function fillAliceInput(ev) {
          in_gb.value = in_put.value;
          out_gab.value = compute(in_gb.value, in_p.value, in_a.value);
      }

      function fillBobInput_OFF(ev) {
          var r = Extract(in_put.value);
          in_g.value  = r['g'];
          in_p.value  = r['p'];
          in_ga.value = r['A'];
      }

      function fillBobInput(ev) {
          in_ga.value = in_put.value;
      }

      function compute(gx, px, nx) {
          var g = new BigNumber(gx);
          var p = new BigNumber(px);
          var n = new BigNumber(nx);

          //return res = (g.pow(n)).mod(p);
          return ExpMod(g, n, p);
      }

      function runAlice(ev) {
          in_ga.value = compute(in_g.value, in_p.value, in_a.value);
          //out_put.value = "[" + in_p.value + ", " + in_g.value + "; " + in_ga.value + "]";
          out_put.value = in_ga.value;
      }

      function runBob(ev) {
          in_gb.value = compute(in_g.value, in_p.value, in_b.value);
          out_gab.value = compute(in_ga.value, in_p.value, in_b.value);
          out_put.value = in_gb.value;
      }

    </script>

  </head>

  <body>
    <h1>Secret Exchange</h1>

    <form>
      <fieldset>
      <legend>The public data</legend>
      <table>
        <tbody>
          <tr>
            <th><var>g</var> (public)</th>
            <td><input name="in_g" id="in_g" readonly="readonly"></td>
          </tr>
          <tr>
            <th><var>p</var> (public)</th>
            <td><input name="in_p" id="in_p" readonly="readonly"></td>
          </tr>
          <tr>
            <th><var>g</var><sup><var>a</var></sup> (public)</th>
            <td><input name="in_ga" id="in_ga"></td>
          </tr>
          <tr>
            <th><var>g</var><sup><var>b</var></sup> (public)</th>
            <td><input name="in_gb" id="in_gb"></td>
          </tr>
        </tbody>
      </table>
      </fieldset>
    </form>

    <form>
      <fieldset>
      <legend>Alice's private data</legend>
      <table>
        <tbody>
          <tr>
            <th><var>a</var> (secret)</th>
            <td><input name="in_a" id="in_a"></td>
          </tr>
        </tbody>
      </table>
      </fieldset>
    </form>

    <form>
      <fieldset>
      <legend>Bob's private data</legend>
      <table>
        <tbody>
          <tr>
            <th><var>b</var> (secret)</th>
            <td><input name="in_b" id="in_b"></td>
          </tr>
        </tbody>
      </table>
      </fieldset>
    </form>

    <form>
      <fieldset>
      <legend>The shared secret</legend>
      <table>
        <tbody>
          <tr>
            <th><var>g</var><sup><var>ab</var></sup> (secret)</th>
            <td><input name="out_gab" id="out_gab"></td>
          </tr>
        </tbody>
      </table>
      </fieldset>
    </form>

    <p><strong>If you are Alice:</strong> Enter <label for="in_p"><var>p</var></label>,
    <label for="in_g"><var>g</var></label> and <label for="in_a"><var>a</var></label>.
    Then transmit the data to Bob. <input type="button" id="go_a" value="1. I am Alice; initiate."></p>

    <p><strong>If you are Bob:</strong> Wait for the data and enter <label for="in_p"><var>p</var></label>,
    <label for="in_g"><var>g</var></label>, <label for="in_b"><var>b</var></label> and
    <label for="in_ga"><var>g</var><sup><var>a</var></label>. Then send
    <label for="in_gb"><var>g</var><sup><var>b</var></label> to Bob.
    <input type="button" id="go_b" value="4. I am Bob; make shared secret."></p>

    <p><strong>Alice again:</strong> Upon receiving Bob's message, enter
    <label for="in_gb"><var>g</var><sup><var>b</var></label> below.</p>

    <form>
      <fieldset>
      <legend>Input/Output</legend>
      <table>
        <tbody>
          <tr>
            <th>Input</th>
            <td><input name="in_put" id="in_put"></td>
            <td><input type="button" id="but_rb" value="3. Read as Bob">
                <input type="button" id="but_ra" value="6. Read as Alice and compute shared secret"></td>
          </tr>
          <tr>
            <th>Output</th>
            <td><input name="out_put" id="out_put"></td>
            <td>2. Send to Bob. 5. Send to Alice.</td>
          </tr>
        </tbody>
      </table>
      </fieldset>
    </form>

  </body>
</html>
